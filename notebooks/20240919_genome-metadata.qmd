---
title: "Comparison of Genome Metadata"
author: "Kat Terwelp"
format: html
editor: visual
---

## Comparison of Genome Metadata

## Motivation

### **Goal:**

-   Determine whether the two methods to acquire genome + drug metadata produce different results.

### **Background:**

The Two Methods

-   TaxonID or genome_name

-   Is genome_name just adding junk or is it worthwhile to keep?

Inputs

-   `metadata/` contains the following files:

    -   `*_data.tsv` = genome metadata

    -   `*_drug.tsv` = drug metadata

    -   `##_*` = taxonID version

    -   `genus-species_*` = genome_name version

## Analysis

### Load libraries

```{r}
library(readr)
# import tsv/text files into tibble 
library(readxl)
# import excel files into tibble
library(tidyverse)
# dplyr for cleaning tibbles
# ggplot for visualizing cleaned tibble
library(skimr)
# for creating quick summary tables
library(curl)
# download genomes from BV BRC
library(rentrez)
# download genomes from NCBI
```

### Import data and clean

Set up variables

```{r}
col.types.genome <- cols(genome.genome_id...1 = col_character(),
  genome._version_ = col_double(),
  genome.additional_metadata = col_character(), # multi-valued
  genome.altitude = col_character(),
  genome.antimicrobial_resistance = col_character(), # multi-valued
  genome.antimicrobial_resistance_evidence = col_character(),
  genome.assembly_accession = col_character(),
  genome.assembly_method = col_character(),
  genome.authors = col_character(),
  genome.bioproject_accession = col_character(),
  genome.biosample_accession = col_character(),
  genome.biovar = col_character(),
  genome.body_sample_site = col_character(),
  genome.body_sample_subsite = col_character(),
  genome.cds = col_double(),
  genome.cds_ratio = col_double(),
  genome.cell_shape = col_character(),
  genome.checkm_completeness = col_double(),
  genome.checkm_contamination = col_double(),
  genome.chromosomes = col_double(),
  genome.clade = col_character(),
  genome.class = col_character(),
  genome.coarse_consistency = col_double(),
  genome.collection_date = col_character(),
  genome.collection_year = col_double(),
  genome.comments = col_character(), # multi-valued
  genome.common_name = col_character(),
  genome.completion_date = col_datetime(format = ""),
  genome.contig_l50 = col_double(),
  genome.contig_n50 = col_double(),
  genome.contigs = col_double(),
  genome.core_families = col_double(),
  genome.core_family_ratio = col_double(),
  genome.culture_collection = col_character(),
  genome.date_inserted = col_datetime(format = ""),
  genome.date_modified = col_datetime(format = ""),
  genome.depth = col_character(),
  genome.disease = col_character(), # multi-valued
  genome.family = col_character(),
  genome.fine_consistency = col_double(),
  genome.gc_content = col_double(),
  genome.genbank_accessions = col_character(),
  genome.genetic_code = col_character(),
  genome.genome_id...44 = col_character(), # Added multiple genome_id
  genome.genome_length = col_double(),
  genome.genome_name = col_character(),
  genome.genome_quality = col_character(),
  genome.genome_quality_flags = col_character(), # multi-valued
  genome.genome_status = col_character(),
  genome.genus = col_character(),
  genome.geographic_group = col_character(),
  genome.geographic_location = col_character(),
  genome.gram_stain = col_character(),
  genome.h1_clade_global = col_character(),
  genome.h1_clade_us = col_character(),
  genome.h3_clade = col_character(),
  genome.h5_clade = col_character(),
  genome.h_type = col_character(),
  genome.habitat = col_character(),
  genome.host_age = col_character(),
  genome.host_common_name = col_character(),
  genome.host_gender = col_character(),
  genome.host_group = col_character(),
  genome.host_health = col_character(),
  genome.host_name = col_character(),
  genome.host_scientific_name = col_character(),
  genome.hypothetical_cds = col_double(),
  genome.hypothetical_cds_ratio = col_double(),
  genome.isolation_comments = col_character(),
  genome.isolation_country = col_character(),
  genome.isolation_site = col_character(),
  genome.isolation_source = col_character(),
  genome.kingdom = col_character(),
  genome.lab_host = col_character(),
  genome.latitude = col_character(),
  genome.lineage = col_character(),
  genome.longitude = col_character(),
  genome.mat_peptide = col_character(),
  genome.missing_core_family_ids = col_character(), # multi-valued
  genome.mlst = col_character(),
  genome.motility = col_character(),
  genome.n_type = col_character(),
  genome.ncbi_project_id = col_character(),
  genome.nearest_genomes = col_character(), # multi-valued
  genome.optimal_temperature = col_character(),
  genome.order = col_character(),
  genome.organism_name = col_character(),
  genome.other_clinical = col_character(), # multi-valued
  genome.other_environmental = col_character(), # multi-valued
  genome.other_names = col_character(),
  genome.other_typing = col_character(), # multi-valued
  genome.outgroup_genomes = col_character(), # multi-valued
  genome.owner = col_character(),
  genome.oxygen_requirement = col_character(),
  genome.p2_genome_id = col_double(),
  genome.partial_cds = col_double(),
  genome.partial_cds_ratio = col_double(),
  genome.passage = col_character(),
  genome.pathovar = col_character(),
  genome.patric_cds = col_double(),
  genome.ph1n1_like = col_character(),
  genome.phenotype = col_character(),
  genome.phylum = col_character(),
  genome.plasmids = col_double(),
  genome.plfam_cds = col_double(),
  genome.plfam_cds_ratio = col_double(),
  genome.public = col_logical(),
  genome.publication = col_character(),
  genome.reference_genome = col_character(),
  genome.refseq_accessions = col_character(),
  genome.refseq_cds = col_double(),
  genome.refseq_project_id = col_character(),
  genome.rrna = col_double(),
  genome.salinity = col_character(),
  genome.season = col_character(),
  genome.segment = col_character(),
  genome.segments = col_character(),
  genome.sequencing_centers = col_character(),
  genome.sequencing_depth = col_character(),
  genome.sequencing_platform = col_character(),
  genome.sequencing_status = col_character(),
  genome.serovar = col_character(),
  genome.species = col_character(),
  genome.sporulation = col_character(),
  genome.sra_accession = col_character(),
  genome.state_province = col_character(),
  genome.strain = col_character(),
  genome.subclade = col_character(),
  genome.subtype = col_character(),
  genome.superkingdom = col_character(),
  genome.taxon_id = col_double(),
  genome.taxon_lineage_ids = col_character(),
  genome.taxon_lineage_names = col_character(),
  genome.taxonomy = col_character(),
  genome.temperature_range = col_character(),
  genome.text = col_character(), # multi-valued
  genome.trna = col_double(),
  genome.type_strain = col_character(),
  genome.user_read = col_character(), # multi-valued
  genome.user_write = col_character() # multi-valued
)


col.types.drug <- cols(
  genome.genome_id = col_character(),
  genome_drug.genome_id = col_character(),
  genome_drug.genome_name = col_character(),
  genome_drug.taxon_id = col_double(),
  genome_drug.antibiotic = col_character(),
  genome_drug.resistant_phenotype = col_character(),
  genome_drug.measurement = col_character(),
  genome_drug.measurement_sign = col_character(),
  genome_drug.measurement_value = col_character(),
  genome_drug.measurement_unit = col_character(),
  genome_drug.laboratory_typing_method = col_character(),
  genome_drug.laboratory_typing_method_version = col_character(),
  genome_drug.laboratory_typing_platform = col_character(),
  genome_drug.vendor = col_character(),
  genome_drug.computational_method = col_character(),
  genome_drug.computational_method_version = col_character(),
  genome_drug.computational_method_performance = col_character(),
  genome_drug.testing_standard = col_character(),
  genome_drug.testing_standard_year = col_double(),
  genome_drug.source = col_character(),
  genome_drug.pmid = col_double(), # multi-valued
  genome_drug.evidence = col_character(),
  genome_drug.text = col_character(), # multi-valued
  genome_drug._version_ = col_double(),
  genome_drug.date_inserted = col_datetime(format = ""),
  genome_drug.date_modified = col_datetime(format = ""),
  genome_drug.public = col_logical(),
  genome_drug.owner = col_character(),
  genome_drug.user_read = col_character(), # multi-valued
  genome_drug.user_write = col_character() # multi-valued
)
```

```{r}

# import data into tibbles 
projDir="/projects/kterwelp@xsede.org/20240917_BV-BRC-genomes/metadata/"
# list all data files and deduplicate down to unique genomes
data.tsv.ls <- list.files(path = projDir, 
                          pattern = "_data.tsv",
                          full.names = TRUE)

drug.tsv.ls <- list.files(path = projDir, 
                          pattern = "_drug.tsv",
                          full.names = TRUE)

data.tbls <- lapply(data.tsv.ls, function(tsv) read_tsv(tsv, col_types = col.types.genome))
names(data.tbls) <- data.tsv.ls %>%
  basename() %>% 
  str_replace_all("_data.tsv", "") %>% 
  str_replace_all("-", "_") %>% 
  paste0("data_", .)

drug.tbls <- lapply(drug.tsv.ls, function(tsv) read_tsv(tsv, col_types = col.types.drug))
names(drug.tbls) <- drug.tsv.ls %>% 
  basename() %>% 
  str_replace_all("_drug.tsv", "") %>% 
  str_replace_all("-", "_") %>% 
  paste0("drug_", .)

problems(drug.tbls$drug_1280)
unique(drug.tbls$drug_1280$genome_drug.computational_method_performance)
# shifted at the computational methods section for ~6,000 lines. They have Adaboost twice, at computational_method_performance, so shifted beyond that line. Bonus is that we don't want that crap! 

```

### Drug Tbl Comparison

Combine all tables together

```{r}
shrt_names <- names(drug.tbls) %>% str_replace_all("drug_", "")
drug.tbls <- drug.tbls %>% map2(shrt_names, ~ mutate(.x, id_input = .y))

drug.tbl <- bind_rows(drug.tbls)

skim.drug.tbl <- skim(drug.tbl)
# creates summary tibble of all columns

```

Filter to remove any computational methods and clean tibble

```{r}

# several rows are broken, we can remove those with: 
## broken where AdaBoost Classifier is copied twice into computational_method_performance

drug.tbl <- drug.tbl %>% filter(genome_drug.computational_method_performance != "AdaBoost Classifier" | is.na(genome_drug.computational_method_performance))

unique(drug.tbl$genome_drug.laboratory_typing_method)
# we want to change "missing" to "NA" because they are the same

drug.tbl <- drug.tbl %>% 
  mutate(genome_drug.laboratory_typing_method = na_if(genome_drug.laboratory_typing_method, "missing"))

unique(drug.tbl$genome_drug.laboratory_typing_method)

# remove NAs for drug resistance phenotypes
unique(drug.tbl$genome_drug.resistant_phenotype)
# unfortunately there are some NAs here which we cannot use

drug.tbl <- drug.tbl %>% 
  filter(!is.na(genome_drug.resistant_phenotype))

unique(drug.tbl$genome_drug.resistant_phenotype)
# we also want to change "nonsusceptible" to "resistant" 

drug.tbl <- drug.tbl %>% 
  mutate(genome_drug.resistant_phenotype = case_when(genome_drug.resistant_phenotype == "Nonsusceptible" ~ "Resistant", 
                                                     .default = genome_drug.resistant_phenotype))

# remove any columns with <5% completion

mostly_na_columns <- skim.drug.tbl %>% 
    filter(complete_rate < 0.05) %>% # select variables that have <5% completion
  pull(skim_variable)

mostly_na_columns
# 6 columns

drug.tbl <- drug.tbl %>% 
  select(-any_of(mostly_na_columns))

length(mostly_na_columns)
length(colnames(drug.tbl))
colnames(drug.tbl)


unique(drug.tbl$genome_drug.resistant_phenotype)
unique(drug.tbl$genome_drug.computational_method)
# we want to remove anything that is "AdaBoost Classifier" 

# remove anything computational
filt.drug.tbl <- drug.tbl %>%
  filter(genome_drug.computational_method != "AdaBoost Classifier" | is.na(genome_drug.computational_method))
# this removed 200,000 lines

unique(filt.drug.tbl$genome_drug.computational_method)

unique(filt.drug.tbl$genome_drug.laboratory_typing_method)
# we don't want "Computational Prediction" 


filt.drug.tbl <- filt.drug.tbl %>% 
  filter(genome_drug.laboratory_typing_method != "Computational Prediction" | is.na(genome_drug.laboratory_typing_method))


# do any of the columns only have NA?

na_columns <- filt.drug.tbl %>%
  summarise(across(everything(), ~ all(is.na(.)))) %>%
  gather(key = "column", value = "all_na") %>%
  filter(all_na) %>%
  pull(column)

na_columns
# we will remove all these columns from our dataset

length(na_columns)
length(colnames(filt.drug.tbl))

filt.drug.tbl <- filt.drug.tbl %>% 
  select(-any_of(na_columns))

length(colnames(filt.drug.tbl))
colnames(filt.drug.tbl)

```

Visualize tbl

```{r}
# how many different drugs for each input_id? 

unique(filt.drug.tbl$genome_drug.antibiotic)
# there are a LOT of antibiotics

filt.drug.tbl %>% 
  filter(id_input == "Staphylococcus_aureus" | id_input == "Pseudomonas_aeruginosa") %>% 
  group_by(id_input, genome_drug.antibiotic) %>% 
  summarise(count = n(), uniq.genomes = length(unique(genome.genome_id))) %>% 
  filter(count > 100) %>% # more than 100 entries
  ungroup() %>% 
  group_by(genome_drug.antibiotic) %>% 
  filter(n() > 1) %>% # exist for both S.aureus and P.aeruginosa
  ungroup()

filt.drug.tbl %>% 
  filter(id_input == "Staphylococcus_aureus" | id_input == "Pseudomonas_aeruginosa") %>% 
  group_by(id_input, genome_drug.antibiotic) %>% 
  summarise(count = n(), uniq.genomes = length(unique(genome.genome_id))) %>% 
  filter(count > 50) %>% # more than 50 entries
  ungroup() %>% 
  group_by(genome_drug.antibiotic) %>% 
  filter(n() > 1) %>% # exist for both S.aureus and P.aeruginosa
  ungroup()

# these could be good candidates for AMR models
## Ciprofloxacin
## Gentamicin
## Levofloxacin

## Cipro + Levo are both quinolones (contain ending "floxacin")

## Gentamicin is an aminoglycoside antibiotic (contain ending "mycin", "micin", "kacin")

# how many quinolones do both species have? 

filt.drug.tbl %>% 
  filter(id_input == "Staphylococcus_aureus" | id_input == "Pseudomonas_aeruginosa") %>% 
  mutate(antibiotic_class = case_when(str_detect(genome_drug.antibiotic, "floxacin") ~ "quinolone", 
                                      .default = genome_drug.antibiotic)) %>% 
  filter(antibiotic_class == "quinolone") %>% 
  group_by(id_input, genome_drug.resistant_phenotype) %>% 
  summarise(count = n(), uniq.genomes = length(unique(genome.genome_id)))

# Is 1618 and 3303 enough? - yes according to Janani


# how many aminoglycosides do both species have? 
aminoglyc.ls <- c("gentamicin", "tobramycin", "amikacin", "neomycin", "plazomicin", "streptomycin", "paromomycin")
# aminoglycoside antibiotics 
aminoglyc_pattern <- paste(aminoglyc.ls, collapse = "|")
# converted into regex pattern

filt.drug.tbl.anti <- filt.drug.tbl %>%
    mutate(antibiotic_class = case_when(str_detect(genome_drug.antibiotic, "floxacin") ~ "quinolone", 
                                        str_detect(genome_drug.antibiotic, aminoglyc_pattern) ~ "aminoglycoside",
                                      .default = genome_drug.antibiotic)) %>% 
  filter(antibiotic_class == "quinolone" | antibiotic_class == "aminoglycoside")

filt.drug.tbl.anti %>% 
  filter(antibiotic_class == "aminoglycoside") %>% 
  group_by(id_input, genome_drug.resistant_phenotype) %>% 
  summarise(count = n(), uniq.genomes = length(unique(genome.genome_id)))


# are the genomes that are resistant to one drug, also resistant to others? 

filt.drug.tbl.anti %>% 
  ungroup() %>% 
  group_by(genome.genome_id) %>%
  filter(antibiotic_class == "quinolone") %>% 
  summarise(count = n(), uniq.drugs = length(unique(genome_drug.antibiotic)), uniq.resistance = length(unique(genome_drug.resistant_phenotype)), uniq.resistant.ls <- unique(genome_drug.resistant_phenotype)) %>% 
  filter(uniq.resistance > 1)

## within the same class, the same genome can be resistant or susceptible

  
```

### Genome Metadata Comparison

I've found some drugs of interest, how do the genomes look?

**Set up genome table**

```{r}
# combine genome data into combined table 
shrt_names <- names(data.tbls) %>% str_replace_all("data_", "")
# create column id_input for how they got their id
test.data.tbls <- data.tbls %>% map2(shrt_names, ~ mutate(.x, id_input = .y))
# combine into one table
data.tbl <- bind_rows(test.data.tbls)

skim.data.tbl <- skim(data.tbl)
# some of these columns are entirely or mostly empty, let's remove those
na_columns <- data.tbl %>%
  summarise(across(everything(), ~ all(is.na(.)))) %>%
  gather(key = "column", value = "all_na") %>%
  filter(all_na) %>%
  pull(column)

na_columns
# we will remove all these columns from our dataset
# 31 columns in total are entirely empty

length(na_columns)
length(colnames(data.tbl))

data.tbl <- data.tbl %>% 
  select(-any_of(na_columns))

length(colnames(data.tbl))
colnames(data.tbl)
# 110 columns left 

# some of the columns are mostly empty and will not be used, let's remove those

mostly_na_columns <- skim.data.tbl %>% 
    filter(complete_rate < 0.05) %>% # select variables that have <5% completion
  pull(skim_variable)

mostly_na_columns
# 54 columns 

data.tbl <- data.tbl %>% 
  select(-any_of(mostly_na_columns))

length(colnames(data.tbl))
# 87 columns left 

# keep only one genomeID column 
data.tbl <- data.tbl %>% 
  select(-genome.genome_id...44)

data.tbl <- data.tbl %>% 
  rename(genome.genome_id = genome.genome_id...1) #rename column as genome.genome_id

```

**What genomes are different between taxonID or genome_name**

```{r}
# add variable "id_input.type" 

# sets id_input.type as taxonID if id_input is numeric, otherwise genome_name
data.tbl <- data.tbl %>% 
  mutate(id_input.type = case_when(suppressWarnings(!is.na(as.numeric(id_input))) ~ "taxonID", 
                                                     .default = "genome_name"))

# check that it worked: 
data.tbl %>% filter(id_input.type == "taxonID") %>% pull(id_input) %>% unique()
data.tbl %>% filter(id_input.type == "genome_name") %>% pull(id_input) %>% unique()

# what rows are different between taxonID and genome_name? 

taxonID.data.tbl <- data.tbl %>% filter(id_input.type == "taxonID")
genomeName.data.tbl <-  data.tbl %>% filter(id_input.type == "genome_name")

# extract genomes
taxonID.genomes <- taxonID.data.tbl %>% pull(genome.genome_id)
genomeName.genomes <- genomeName.data.tbl %>% pull(genome.genome_id)

# genomes only in taxonID
taxonID.only <- setdiff(taxonID.genomes, genomeName.genomes)
# only two genomes are taxonID only 
genomeName.only <- setdiff(genomeName.genomes, taxonID.genomes)
# 4457 genomes are in genomeName only

taxonID.data.tbl <- taxonID.data.tbl %>% filter(genome.genome_id %in% taxonID.only)
taxonID.data.tbl %>% pull(genome.species)

genomeName.data.tbl <- genomeName.data.tbl %>% filter(genome.genome_id %in% genomeName.only)
skim.genomeName.data.tbl <- skim(genomeName.data.tbl)
genomeName.data.tbl %>% pull(genome.species) %>% unique()
# interestingly, there are several staphylococcus species, what happens if I remove those? 

genomeName.data.tbl %>% filter(!genome.species %in% c("Pseudomonas aeruginosa", "Staphylococcus aureus")) %>% pull(genome.genome_id) %>% length()
# 4452 are either P.aeuringosa or S.aurues, so only 5 are these other Staph species

genomeName.data.tbl.alt <- genomeName.data.tbl %>% filter(!genome.species %in% c("Pseudomonas aeruginosa","Staphylococcus aureus")) #not the expected genome.species

# interestingly these genome common names are "staphylococcus aureus
# going to ignore since it's only five. The rest look alright! Going to stick with genomeName data from now on. 


```

**How many unique genomes do we have?**

```{r}
# total genomes from each type originally 
filt.drug.tbl %>% 
  group_by(id_input) %>% 
  summarize(uniq.genomes = length(unique(genome.genome_id)), uniq.anti = length(unique(genome_drug.antibiotic)), rows = n())

# 287 taxonID for P.a
# 1280 taxonID for S.a

# let's also look at the original raw data
drug.tbl %>% 
  group_by(id_input) %>% 
  summarize(uniq.genomes = length(unique(genome.genome_id)), uniq.anti = length(unique(genome_drug.antibiotic)), rows = n())

## after filtering we're losing more than half of the data 


```

**Combine genome data with drug**

```{r}

# can I combine now? 

joined.tbl <- inner_join(drug.tbl, data.tbl, relationship = "many-to-many")


```

### Combined Table Analysis

```{r}
# Fix up evidence column

joined.tbl$genome_drug.laboratory_typing_method %>% unique()
# Computational Prediction shouldn't be laboratory typing 

lab.methods <- c("MIC", "Broth dilution", "Disk diffusion", "Agar dilution")
# "Broth dilution, Disk diffusion, MIC, Agar dilution" are all labortory methods


joined.tbl %>% filter(is.na(genome_drug.evidence)) %>% pull(genome_drug.laboratory_typing_method) %>% unique()
# NA in genome_drug.evidence still has computational prediction, MIC, disk diffusion, etc

joined.tbl %>% filter(genome_drug.evidence == "Laboratory Method") %>% pull(genome_drug.laboratory_typing_method) %>% unique()

joined.tbl <- joined.tbl %>% 
  mutate(genome_drug.evidence = case_when(
    genome_drug.laboratory_typing_method %in% lab.methods ~ "Laboratory Method", 
  genome_drug.laboratory_typing_method == "Computational Prediction" ~ "Computational Method",
  .default = genome_drug.evidence
  ))

joined.tbl %>% filter(is.na(genome_drug.evidence)) %>% pull(genome_drug.laboratory_typing_method) %>% unique()
# now all NAs

joined.tbl %>% filter(genome_drug.evidence == "Laboratory Method") %>% pull(genome_drug.laboratory_typing_method) %>% unique()
# now no computational prediction

# also want to have just the Species info 

skim.joined.tbl <- skim(joined.tbl)

```

**Table summaries of joined table**

```{r}
# different summaries of the table 
joined.tbl %>% group_by(genome_drug.resistant_phenotype) %>% distinct(genome.genome_id) %>% count()
joined.tbl %>% group_by(genome_drug.evidence) %>% distinct(genome.genome_id) %>% count()
joined.tbl %>% group_by(genome.genome_status) %>% distinct(genome.genome_id) %>% count()
joined.tbl %>% group_by(genome.genome_quality) %>% distinct(genome.genome_id) %>% count()
joined.tbl %>% group_by(genome.geographic_location, genome.isolation_country) %>% distinct(genome.genome_id) %>% count()
```

**Prepare table for visualizations**

```{r}
# initial table
plot.tbl <- joined.tbl %>% filter(genome_drug.evidence == "Laboratory Method") %>%
  select(genome.genome_id, genome_drug.antibiotic, genome_drug.resistant_phenotype, genome_drug.laboratory_typing_method, genome.isolation_country, genome.collection_year, genome.host_common_name, genome.species, genome.assembly_accession, genome.genbank_accessions) %>% 
  distinct()



# read the file with antibiotic classes
antibiotics_classes <- read_excel("/projects/kterwelp@xsede.org/20240917_BV-BRC-genomes/metadata/antibiotics_classes2.0.xlsx")

# add the class column
plot.tbl <- merge(plot.tbl, antibiotics_classes, by = "genome_drug.antibiotic", all.x = T)

# check that there are no NA antibiotic classes 
plot.tbl %>% filter(is.na(genome_drug.antibiotic_class)) %>% pull(genome_drug.antibiotic) %>% unique()
# if there are, add those to the excel file and repeat

year.tbl <- plot.tbl %>% dplyr::filter(!is.na(genome.collection_year)) 

summary.year <- year.tbl %>% group_by(genome.species, genome_drug.antibiotic_class, genome_drug.resistant_phenotype, genome.collection_year) %>% summarise(count = n())
summary.year

top.drugs.tbl <- summary.year %>% ungroup() %>%
  group_by(genome.species, genome_drug.antibiotic_class) %>% 
  summarise(cases = sum(count))

top.drugs.tbl %>% arrange(desc(cases))

top.drugs.sau <- top.drugs.tbl %>% 
  filter(genome.species == "Staphylococcus aureus") %>% 
  arrange(desc(cases)) %>% 
  slice(1:7) %>% # take top 7 most prevalent antibiotic classes
  pull(genome_drug.antibiotic_class)

top.drugs.pae <- top.drugs.tbl %>% 
  filter(genome.species == "Pseudomonas aeruginosa") %>% 
  arrange(desc(cases)) %>% 
  slice(1:7) %>% # take top 7 most prevalent antibiotic classes
  pull(genome_drug.antibiotic_class)

top.drugs <- union(top.drugs.pae, top.drugs.sau)
top.drugs
# top most prevalent drugs used for both species

# edit summary.year to only include top drugs
## anything not in the top drugs labeled "others"
summary.year <- summary.year %>% 
  mutate(genome_drug.antibiotic_class = case_when(genome_drug.antibiotic_class %in% top.drugs ~genome_drug.antibiotic_class, 
                                                  .default = "others"))
```

**Visualizations**

Yearwise Plot of Resistance Data for top 10 Antibiotic Class

```{r}
# Plot the yearwise Resistant data for different antibiotic class 
p <- ggplot(summary.year %>% 
              filter(genome_drug.resistant_phenotype == "Resistant",
                     genome.species == "Pseudomonas aeruginosa"), aes(x = genome.collection_year, y = count, colour = genome_drug.antibiotic_class)) 
p <- p + 
  geom_line() + geom_point() + 
  labs(title = "Resistant Phenotype Distribution Over the Years by Antibiotic",
       x = "Year",
       y = "Number of Cases",
       colour = "Antibiotics") +
  facet_wrap(~ genome.species) +
  theme_minimal() + theme(legend.position = "bottom", 
                          legend.text = element_text(size = 5), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14))
p


p <- ggplot(summary.year %>% 
              filter(genome_drug.resistant_phenotype == "Resistant", 
                     genome.species == "Staphylococcus aureus"), aes(x = genome.collection_year, y = count, colour = genome_drug.antibiotic_class)) 
p <- p + 
  geom_line() + geom_point() + 
  labs(title = "Resistant Phenotype Distribution Over the Years by Antibiotic",
       x = "Year",
       y = "Number of Cases",
       colour = "Antibiotics") +
  facet_wrap(~ genome.species) +
  theme_minimal() + theme(legend.position = "bottom", 
                          legend.text = element_text(size = 5), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14))
p

```

```{r}
# Summarise the data as antiotics
summary.drugs <- plot.tbl %>% 
  group_by(genome.species, genome_drug.antibiotic, genome_drug.antibiotic_class, genome_drug.resistant_phenotype) %>% summarise(count = n())
summary.drugs


top.drugs.tbl <- summary.drugs %>% ungroup() %>%
  group_by(genome.species, genome_drug.antibiotic_class) %>% 
  summarise(cases = sum(count))

top.drugs.tbl %>% arrange(desc(cases))

top.drugs.sau <- top.drugs.tbl %>% 
  filter(genome.species == "Staphylococcus aureus") %>% 
  arrange(desc(cases)) %>% 
  slice(1:4) %>% # take top 4 most prevalent antibiotic classes
  pull(genome_drug.antibiotic_class)

top.drugs.pae <- top.drugs.tbl %>% 
  filter(genome.species == "Pseudomonas aeruginosa") %>% 
  arrange(desc(cases)) %>% 
  slice(1:4) %>% # take top 4 most prevalent antibiotic classes
  pull(genome_drug.antibiotic_class)

top.drugs <- union(top.drugs.pae, top.drugs.sau)
top.drugs


# Barplot of three phenotypes coloured on antibiotics
ggplot(summary.drugs %>% 
         filter(genome_drug.antibiotic_class %in% top.drugs,
                genome.species == "Pseudomonas aeruginosa"), aes(x = genome_drug.resistant_phenotype, y = count, fill = genome_drug.antibiotic_class)) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Phenotype Counts by Antibiotic",
       x = "Phenotype",
       y = "Number of Cases",
       fill = "Antibiotic") +
  facet_wrap(~ genome.species) +
  theme_minimal() + 
  theme(legend.position = "bottom", legend.position.inside =  c(.75, .75), 
        legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) 


ggplot(summary.drugs %>% 
         filter(genome_drug.antibiotic_class %in% top.drugs,
                genome.species == "Staphylococcus aureus"), aes(x = genome_drug.resistant_phenotype, y = count, fill = genome_drug.antibiotic_class)) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Phenotype Counts by Antibiotic",
       x = "Phenotype",
       y = "Number of Cases",
       fill = "Antibiotic") +
  facet_wrap(~ genome.species) +
  theme_minimal() + 
  theme(legend.position = "bottom", legend.position.inside =  c(.75, .75), 
        legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) 

# From these plots: aminoglycosides, cephalosporins, and fluoroquinolones are pretty popular for both species. 

```

**Plots for each of the top 3 drug classes**

**Cephalosporins**

```{r}
summary.drugs
# lets take the top 3: aminoglycosides, cephalosporins, fluorquinolones

p.tbl <- summary.drugs %>% 
  filter(genome_drug.antibiotic_class == "cephalosporins", 
         count > 10) # removing anything w/ less than 10 results

# what's the top drugs used for each

p.tbl$genome_drug.antibiotic %>% unique() %>% length()
# 8 antibiotics total in this class

p.tbl %>% ggplot(aes(x = genome.species, y = count, fill = genome_drug.antibiotic)) +
      geom_bar(position="stack", stat="identity") +
  theme_minimal() + 
  theme(legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) +
    labs(title = "Antibiotic Counts of Cephalosporins",
       x = "Species",
       y = "Number of Cases",
       fill = "Antibiotic") 

  # looks like they generally are different antibiotics used
```

**Aminoglycosides**

```{r}

p.tbl <- summary.drugs %>% 
  filter(genome_drug.antibiotic_class == "aminoglycosides", 
         count > 10) # removing anything w/ less than 10 results

# what's the top drugs used for each

p.tbl$genome_drug.antibiotic %>% unique() %>% length()
# 8 antibiotics total in this class

p.tbl %>% ggplot(aes(x = genome.species, y = count, fill = genome_drug.antibiotic)) +
      geom_bar(position="stack", stat="identity") +
  theme_minimal() + 
  theme(legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) +
    labs(title = "Antibiotic Counts of Aminoglycosides",
       x = "Species",
       y = "Number of Cases",
       fill = "Antibiotic") 

# Gentamicin is preferred for S.auerues
# Amikacin/Tobramycin is used for P.aerugionsa 
## basically no Amikacin for S. aureus 
```

**Fluroquinolones**

```{r}

p.tbl <- summary.drugs %>% 
  filter(genome_drug.antibiotic_class == "fluoroquinolones", 
         count > 10) # removing anything w/ less than 10 results

# what's the top drugs used for each

p.tbl$genome_drug.antibiotic %>% unique() %>% length()
# 8 antibiotics total in this class

p.tbl %>% ggplot(aes(x = genome.species, y = count, fill = genome_drug.antibiotic)) +
      geom_bar(position="stack", stat="identity") +
  theme_minimal() + 
  theme(legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) +
    labs(title = "Antibiotic Counts of Fluoroquinolones",
       x = "Species",
       y = "Number of Cases",
       fill = "Antibiotic") 

# Cipro or Levo used for P.ae
# Cipro preferred S.au
## no Moxi in P.ae 
```

**Ciprofloxacin vs Levofloxacin**

```{r}

p.tbl <- summary.drugs %>% 
  filter(genome_drug.antibiotic %in% c("ciprofloxacin", "levofloxacin"))

ggplot(p.tbl, aes(x = genome_drug.resistant_phenotype, y = count, fill = genome_drug.antibiotic)) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Phenotype Counts by Antibiotic",
       x = "Phenotype",
       y = "Number of Cases",
       fill = "Antibiotic") +
  facet_wrap(~ genome.species) +
  theme_minimal() + 
  theme(legend.position = "bottom", legend.position.inside =  c(.75, .75), 
        legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) 
         
# not very balanced for S.auerus : Levo combo 

```

**Aminoglycosides without** Amikacin

```{r}
p.tbl <- summary.drugs %>% 
  filter(genome_drug.antibiotic_class == "aminoglycosides", 
         count > 10, 
         genome_drug.antibiotic != "amikacin") # removing anything w/ less than 10 results

ggplot(p.tbl, aes(x = genome_drug.resistant_phenotype, y = count, fill = genome_drug.antibiotic)) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Phenotype Counts by Antibiotic",
       x = "Phenotype",
       y = "Number of Cases",
       fill = "Antibiotic") +
  facet_wrap(~ genome.species) +
  theme_minimal() + 
  theme(legend.position = "bottom", legend.position.inside =  c(.75, .75), 
        legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) 


# this graph is hard to see, clearly gentamicin is preferred by S.aureus

p.tbl <- summary.drugs %>% 
  filter(genome_drug.antibiotic_class == "aminoglycosides", 
         count > 10, 
         !(genome_drug.antibiotic %in% c("amikacin", "gentamicin"))) # removing anything w/ less than 10 results

ggplot(p.tbl, aes(x = genome_drug.resistant_phenotype, y = count, fill = genome_drug.antibiotic)) +
  geom_bar(stat = "identity", position = "dodge")+
  labs(title = "Phenotype Counts by Antibiotic",
       x = "Phenotype",
       y = "Number of Cases",
       fill = "Antibiotic") +
  facet_wrap(~ genome.species) +
  theme_minimal() + 
  theme(legend.position = "bottom", legend.position.inside =  c(.75, .75), 
        legend.text = element_text(size = 14), legend.title = element_text(size = 14), axis.title = element_text(size = 14), axis.text = element_text(size = 14)) 
```

## Downloading genomes

### List of genomes

```{r}

#desired drug pairs: 
## gentamicin and tobramycin
## ciprofloxacin and levofloxacin

drug.ls <- c("gentamicin", "tobramycin", "ciprofloxacin", "levofloxacin")
genome.ls.tbl <- plot.tbl %>% 
  filter(genome_drug.antibiotic %in% drug.ls) 

genome.ls <- genome.ls.tbl %>% pull(genome.genome_id) %>% unique()
# total 4367 genomes from both species 

genome.acc.ls <- genome.ls.tbl %>% 
  filter(!is.na(genome.assembly_accession)) %>% 
           pull(genome.assembly_accession) %>% unique()
# only 1195 genomes :/ , losing like a third
## have to use this because ftp isn't working for bv-brc 
```

### Download genomes

In the folder: [ftp://ftp.bvbrc.org/genomes/](ftp://ftp.bvbrc.org/genomes/511145.12)genome_id

-   .fna: FASTA contig sequences

-   .faa: FASTA protein sequence file

-   .features.tab: All genomic features and related information in tab-delimited format

-   .ffn: FASTA nucleotide sequences for genomic features, i.e. genes, RNAs, and other misc features

-   .frn: FASTA nucleotide sequences for RNAs

-   .gff: Genome annotations in GFF file format

-   .pathway.tab: Metabolic pathway assignments in tab-delimited format

-   .spgene.tab: Specialty gene assignements (i.e. AMR genes, virulance factors, essential genes, etc) in tab-delimited format

-   .subsystem.tab: Subsystem assignments in tab-delimited format

for i in `cat genome_ids.txt` do wget -qN "<ftp://ftp.bvbrc.org/genomes/>$i/$i.PATRIC.gff" wget -qN "<ftp://ftp.bvbrc.org/genomes/>$i/$i.fna" wget -qN "<ftp://ftp.bvbrc.org/genomes/>$i/$i.RefSeq.gff" done

```{r}
# download all genomes with accession numbers

acc.ls.tbl <- genome.ls.tbl %>% 
  filter(!is.na(genome.assembly_accession))

  
acc.ls.tbl %>% 
  group_by(genome.species, genome_drug.antibiotic) %>% 
  summarise(count_assemblies = length(unique(genome.assembly_accession)), count_accensions = length(unique(genome.genbank_accessions)))
# list of expected genomes using NCBI database


write_csv()

```

```{r}
# download all genomes with genomeID

dataFol <- "/projects/kterwelp@xsede.org/20240917_BV-BRC-genomes/data/"

download.df <- lapply(genome.ls, function(genome_id) {
  # generate file names
  P.gff <- paste0("ftp://ftp.bvbrc.org/genomes/", genome_id, "/", genome_id, ".PATRIC.gff")
  R.gff <- paste0("ftp://ftp.bvbrc.org/genomes/", genome_id, "/", genome_id, ".RefSeq.gff")
  fna <- paste0("ftp://ftp.bvbrc.org/genomes/", genome_id, "/", genome_id, ".fna")
  files <- c(P.gff = P.gff, R.gff = R.gff, fna = fna)
  
  # generate destination names
  P.gff.dest <- paste0(dataFol, genome_id, ".PATRIC.gff")
  R.gff.dest <- paste0(dataFol, genome_id, ".RefSeq.gff")
  fna.dest <- paste0(dataFol, genome_id, ".fna")
  dests <- c(P.gff.dest, R.gff.dest, fna.dest)
  
  #download files
  download.df <- multi_download(urls = files, destfiles = dests)
  ## multi_download generates a dataframe with error information for all files downloaded
  
  download.df <- download.df %>% 
    mutate(genome.genome_id = genome_id, # add genome_id col 
           file_type = case_when(grepl("PATRIC.gff", url) ~ "PATRIC.gff", 
                                 grepl(".RefSeq.gff", url) ~ ".RefSeq.gff", 
                                 grepl(".fna", url) ~ ".fna", 
                                 .default = NA))
  # add file_type col, can test which files are least likely to exist

}) %>% 
  bind_rows()


```
